<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sari3 Store</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f3f4f6; padding-bottom: 80px; }
        .product-card { transition: transform 0.2s; }
        .product-card:active { transform: scale(0.98); }
        /* Hide scrollbar for category list */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>

    <!-- HEADER -->
    <div class="bg-white shadow-sm p-4 sticky top-0 z-50">
        <div class="flex justify-between items-center">
            <h1 class="text-xl font-bold text-gray-800" id="store-name">Loading Store...</h1>
            <div class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-bold">Open</div>
        </div>
    </div>

    <!-- CATEGORY FILTER -->
    <div class="flex overflow-x-auto p-4 gap-2 no-scrollbar" id="category-container"></div>

    <!-- PRODUCT GRID -->
    <div class="px-4 pb-4 grid grid-cols-1 gap-4" id="product-container">
        <div class="text-center py-10 text-gray-500">
            <p id="loading-text">Connecting to Sari3 Cloud...</p>
        </div>
    </div>

    <!-- CART BAR -->
    <div id="cart-bar" class="fixed bottom-4 left-4 right-4 bg-gray-900 text-white p-4 rounded-xl shadow-2xl flex justify-between items-center hidden transition-all duration-300 transform translate-y-20 z-50">
        <div class="flex flex-col">
            <span class="text-xs text-gray-400">Total Order</span>
            <span class="font-bold text-lg"><span id="total-price">0.000</span> TND</span>
        </div>
        <button onclick="checkout()" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg font-bold flex items-center gap-2">
            <span>Order WhatsApp</span>
        </button>
    </div>

    <script>
        // *** CONFIGURATION ***
        // This is YOUR specific Master Registry Link
        const MASTER_REGISTRY_URL = "https://docs.google.com/spreadsheets/d/1t57EXGbh1iocTGIh82j3uWqpV0zuv7Mj9RTi5w6YvjI/export?format=csv";
        
        let cart = [];
        let STORE_PHONE = "";
        let STORE_NAME = "";

        // --- 1. INITIALIZE SAAS LOGIC ---
        
        // This gets the '?store=demo' from the URL
        const urlParams = new URLSearchParams(window.location.search);
        let currentSlug = urlParams.get('store');

        // FOR TESTING IN SPCK: 
        // Since Spck doesn't let you easily change URL, we force 'demo' if none exists.
        if (!currentSlug) {
            console.log("No store slug found, defaulting to 'demo' for testing");
            currentSlug = "demo"; 
        }

        // Fetch Master Registry
        Papa.parse(MASTER_REGISTRY_URL, {
            download: true,
            header: true,
            complete: function(results) {
                const registry = results.data;
                console.log("Registry Loaded:", registry); // Debugging

                // Find the store in the list
                const myStore = registry.find(row => row.slug === currentSlug);

                if (myStore) {
                    // STORE FOUND!
                    STORE_NAME = myStore.store_name;
                    STORE_PHONE = myStore.phone;
                    document.getElementById('store-name').innerText = STORE_NAME;
                    
                    // Now Load the Products for this specific store
                    loadProducts(myStore.sheet_url);
                } else {
                    document.getElementById('product-container').innerHTML = `
                        <div class='p-10 text-center text-red-500'>
                            <h1 class='text-2xl font-bold'>404</h1>
                            <p>Store '${currentSlug}' Not Found</p>
                            <p class='text-sm text-gray-400 mt-4'>Make sure you added it to the Registry Sheet</p>
                        </div>`;
                    document.getElementById('store-name').innerText = "Error";
                }
            },
            error: function(err) {
                alert("Error reading Master Registry. Check your link.");
            }
        });

        // --- 2. LOAD PRODUCTS FUNCTION ---
        function loadProducts(sheetUrl) {
            Papa.parse(sheetUrl, {
                download: true,
                header: true,
                complete: function(results) {
                    renderStore(results.data);
                }
            });
        }

        // --- 3. RENDER UI ---
        function renderStore(products) {
            const container = document.getElementById('product-container');
            const catContainer = document.getElementById('category-container');
            
            container.innerHTML = "";
            catContainer.innerHTML = `<button class="bg-gray-800 text-white px-4 py-2 rounded-lg text-sm whitespace-nowrap">All</button>`;

            // Categories
            const categories = [...new Set(products.map(p => p.Category).filter(Boolean))];
            categories.forEach(cat => {
                catContainer.innerHTML += `<button class="bg-white border text-gray-600 px-4 py-2 rounded-lg text-sm whitespace-nowrap">${cat}</button>`;
            });

            // Products
            products.forEach(product => {
                if(!product.Name) return; 
                const imgUrl = product.Image || "https://via.placeholder.com/150";
                
                const card = document.createElement('div');
                card.className = "bg-white p-3 rounded-2xl shadow-sm product-card flex gap-4 items-center";
                
                card.innerHTML = `
                    <div class="h-24 w-24 flex-shrink-0">
                        <img src="${imgUrl}" class="w-full h-full object-cover rounded-xl" alt="${product.Name}">
                    </div>
                    <div class="flex-1 flex flex-col justify-between h-24 py-1">
                        <div>
                            <h3 class="font-bold text-gray-800 leading-tight">${product.Name}</h3>
                            <p class="text-xs text-gray-500 mt-1">${product.Category}</p>
                        </div>
                        <div class="flex justify-between items-end">
                            <span class="font-bold text-green-600 text-lg">${product.Price} <span class="text-xs">TND</span></span>
                            <button onclick="addToCart('${product.Name}', ${product.Price})" class="bg-gray-100 hover:bg-green-100 text-gray-800 hover:text-green-600 w-8 h-8 rounded-full flex items-center justify-center font-bold text-xl">+</button>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // --- 4. CART & CHECKOUT ---
        function addToCart(name, price) {
            cart.push({ name, price });
            updateCartUI();
        }

        function updateCartUI() {
            const total = cart.reduce((sum, item) => sum + parseFloat(item.price), 0);
            document.getElementById('total-price').innerText = total.toFixed(3);
            
            const cartBar = document.getElementById('cart-bar');
            if (cart.length > 0) {
                cartBar.classList.remove('hidden', 'translate-y-20');
            }
        }

        function checkout() {
            const summary = cart.reduce((acc, item) => {
                acc[item.name] = (acc[item.name] || 0) + 1;
                return acc;
            }, {});

            let message = `Salam *${STORE_NAME}*! \n\nI want to order: \n`;
            
            Object.keys(summary).forEach(key => {
                message += `‚ñ™Ô∏è ${summary[key]}x ${key} \n`;
            });

            const total = cart.reduce((sum, item) => sum + parseFloat(item.price), 0);
            message += `\nüí∞ *Total: ${total.toFixed(3)} TND* \n`;
            message += `üìç My Address is: `;

            window.open(`https://wa.me/${STORE_PHONE}?text=${encodeURIComponent(message)}`, '_blank');
        }
    </script>
</body>
</html>